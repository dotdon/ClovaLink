// This is your ClovaLink database schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  USER
}

model Company {
  id                    String                  @id @default(cuid())
  name                  String
  logo                  String?                 // Logo filename
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  employees             Employee[]
  documents             Document[]
  folders               Folder[]
  activities            Activity[]
  downloadLinks         DownloadLink[]
  crossCompanyEmployees EmployeeCompanyAccess[] // Employees with cross-company access

  @@map("companies")
}

model Employee {
  id                  String         @id @default(cuid())
  email               String        @unique
  name                String
  password            String
  role                Role          @default(USER)
  companyId           String        // Primary company
  profilePicture      String?       // Filename of profile picture
  lastLoginAt         DateTime?     // Last login timestamp
  lastLoginIp         String?       // Last login IP address
  lastLoginLocation   String?       // Last login location (city, country)
  isActive            Boolean       @default(false) // Currently active/online
  lastActivityAt      DateTime?     // Last activity timestamp
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  company             Company       @relation(fields: [companyId], references: [id])
  documents           Document[]
  activities          Activity[]
  folders             Folder[]
  downloadLinks       DownloadLink[]
  uploadLinks         UploadLink[]
  passkeys            Passkey[]
  totpSecret          String?       // TOTP secret for 2FA
  totpEnabled         Boolean       @default(false) // Whether 2FA is enabled
  backupCodes         String[]      @default([]) // Backup codes for 2FA (encrypted)
  mustChangePassword  Boolean       @default(false) // Force password change on next login
  crossCompanyAccess  EmployeeCompanyAccess[] // Additional companies this employee can access
  favoriteDocuments   FavoriteDocument[] // Documents favorited by this employee
  favoriteFolders     FavoriteFolder[]   // Folders favorited by this employee
  pinnedFolders       PinnedFolder[]     // Folders pinned by this employee
  loginActivities     LoginActivity[] // Login history
  sentMessages        Message[]       @relation("SentMessages") // Messages sent by this employee
  receivedMessages    Message[]       @relation("ReceivedMessages") // Messages received by this employee
  channelMemberships  ChannelMember[] // Channels this employee is a member of
  notifications       Notification[]  // Notifications for this employee

  @@index([companyId])
  @@index([role])
  @@index([isActive])
  @@map("employees")
}

// Cross-company access for employees
model EmployeeCompanyAccess {
  id          String   @id @default(cuid())
  employeeId  String
  companyId   String
  grantedBy   String   // ID of admin/manager who granted access
  grantedAt   DateTime @default(now())
  
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, companyId]) // One access record per employee per company
  @@index([employeeId])
  @@index([companyId])
  @@map("employee_company_access")
}

model Document {
  id            String         @id @default(cuid())
  name          String
  path          String
  mimeType      String
  size          Int
  metadata      Json?
  employeeId    String
  companyId     String
  folderId      String?
  password      String?        // Encrypted password for document access
  expiresAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  uploadedBy       Employee      @relation(fields: [employeeId], references: [id])
  company          Company       @relation(fields: [companyId], references: [id])
  folder           Folder?       @relation(fields: [folderId], references: [id])
  activities       Activity[]
  downloadLinks    DownloadLink[]
  favorites        FavoriteDocument[] // Users who favorited this document
  messageAttachments MessageAttachment[] // Messages this document is attached to

  @@index([companyId])
  @@index([employeeId])
  @@index([folderId])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("documents")
}

model Folder {
  id            String         @id @default(cuid())
  name          String
  parentId      String?
  companyId     String
  createdById   String
  color         String?       // Optional color for folder (Google Drive style)
  password      String?       // Encrypted password for folder access
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  parent        Folder?       @relation("FolderHierarchy", fields: [parentId], references: [id])
  children      Folder[]      @relation("FolderHierarchy")
  company       Company       @relation(fields: [companyId], references: [id])
  createdBy     Employee      @relation(fields: [createdById], references: [id])
  documents     Document[]
  downloadLinks DownloadLink[]
  favorites     FavoriteFolder[] // Users who favorited this folder
  pinnedBy      PinnedFolder[]   // Users who pinned this folder
  activities    Activity[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([parentId])
  @@index([createdById])
  @@map("folders")
}

model Activity {
  id          String        @id @default(cuid())
  type        String
  description String
  metadata    Json?
  employeeId  String
  documentId  String?
  folderId    String?
  companyId   String
  createdAt   DateTime      @default(now())
  timestamp   DateTime      @default(now())
  ipAddress   String?
  userAgent   String?
  
  employee    Employee      @relation(fields: [employeeId], references: [id])
  document    Document?     @relation(fields: [documentId], references: [id])
  folder      Folder?       @relation(fields: [folderId], references: [id])
  company     Company       @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([documentId])
  @@index([folderId])
  @@index([timestamp])
  @@index([type])
  @@map("activities")
}

model DownloadLink {
  id          String        @id @default(cuid())
  token       String        @unique
  folderId    String?
  documentId  String?
  createdById String
  companyId   String
  expiresAt   DateTime
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isActive    Boolean       @default(true)
  downloads   Int           @default(0)

  folder      Folder?       @relation(fields: [folderId], references: [id], onDelete: Cascade)
  document    Document?     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdBy   Employee      @relation(fields: [createdById], references: [id])
  company     Company       @relation(fields: [companyId], references: [id])

  @@index([token])
  @@index([folderId])
  @@index([documentId])
  @@index([companyId])
  @@map("download_links")
}

model UploadLink {
  id          String        @id @default(cuid())
  name        String?
  token       String        @unique
  maxUses     Int
  useCount    Int           @default(0)
  used        Boolean       @default(false)
  expiresAt   DateTime
  metadata    Json?
  employeeId  String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  employee    Employee      @relation(fields: [employeeId], references: [id])

  @@index([token])
  @@index([employeeId])
  @@index([expiresAt])
  @@index([used])
  @@map("upload_links")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  category    String   // "smtp", "upload", "security", "general"
  description String?
  isEncrypted Boolean  @default(false)
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([category])
  @@map("system_settings")
}

model Passkey {
  id              String   @id @default(cuid())
  credentialId    String   @unique
  publicKey       String   // Base64 encoded public key
  counter         Int      @default(0)
  deviceName      String?  // User-friendly name for the device
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime @default(now())

  @@index([employeeId])
  @@index([credentialId])
  @@map("passkeys")
}

// Login activity tracking
model LoginActivity {
  id             String   @id @default(cuid())
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  loginAt        DateTime @default(now())
  ipAddress      String?
  location       String?  // City, Country
  userAgent      String?  // Browser/device info
  success        Boolean  @default(true)

  @@index([employeeId])
  @@index([loginAt])
  @@map("login_activities")
}

// Messaging system
model Message {
  id              String              @id @default(cuid())
  content         String
  senderId        String
  sender          Employee            @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  recipientId     String?             // For direct messages
  recipient       Employee?           @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  channelId       String?             // For channel messages
  channel         MessageChannel?     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  attachments     MessageAttachment[]
  isRead          Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  notifications   Notification[]

  @@index([senderId])
  @@index([recipientId])
  @@index([channelId])
  @@index([createdAt])
  @@map("messages")
}

// Message channels (group chats, company-wide, etc.)
model MessageChannel {
  id          String    @id @default(cuid())
  name        String
  description String?
  companyId   String
  isPublic    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  messages    Message[]
  members     ChannelMember[]

  @@index([companyId])
  @@map("message_channels")
}

// Channel membership
model ChannelMember {
  id        String         @id @default(cuid())
  channelId String
  channel   MessageChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  employeeId String
  employee  Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  joinedAt  DateTime       @default(now())
  isAdmin   Boolean        @default(false)

  @@unique([channelId, employeeId])
  @@index([channelId])
  @@index([employeeId])
  @@map("channel_members")
}

// Message attachments (links to documents)
model MessageAttachment {
  id         String   @id @default(cuid())
  messageId  String
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@index([messageId])
  @@index([documentId])
  @@map("message_attachments")
}

// Push notifications
model Notification {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  type       String   // 'message', 'document', 'mention', etc.
  title      String
  body       String
  data       Json?    // Additional data (messageId, documentId, etc.)
  isRead     Boolean  @default(false)
  messageId  String?
  message    Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@index([employeeId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Favorite documents (like Google Drive starred files)
model FavoriteDocument {
  id          String   @id @default(cuid())
  employeeId  String
  documentId  String
  createdAt   DateTime @default(now())
  
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, documentId])
  @@index([employeeId])
  @@index([documentId])
  @@map("favorite_documents")
}

// Favorite folders
model FavoriteFolder {
  id         String   @id @default(cuid())
  employeeId String
  folderId   String
  createdAt  DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  folder     Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, folderId])
  @@index([employeeId])
  @@index([folderId])
  @@map("favorite_folders")
}

// Pinned folders (quick access at top)
model PinnedFolder {
  id         String   @id @default(cuid())
  employeeId String
  folderId   String
  order      Int      @default(0) // For custom ordering
  createdAt  DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  folder     Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, folderId])
  @@index([employeeId])
  @@index([folderId])
  @@map("pinned_folders")
} 