// This is your ClovaLink database schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  USER
}

model Company {
  id            String         @id @default(cuid())
  name          String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  employees     Employee[]
  documents     Document[]
  folders       Folder[]
  activities    Activity[]
  downloadLinks DownloadLink[]

  @@map("companies")
}

model Employee {
  id            String         @id @default(cuid())
  email         String        @unique
  name          String
  password      String
  role          Role          @default(USER)
  companyId     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  company       Company       @relation(fields: [companyId], references: [id])
  documents     Document[]
  activities    Activity[]
  folders       Folder[]
  downloadLinks DownloadLink[]
  uploadLinks   UploadLink[]
  passkeys      Passkey[]
  totpSecret    String?       // TOTP secret for 2FA
  totpEnabled   Boolean       @default(false) // Whether 2FA is enabled
  backupCodes   String[]      @default([]) // Backup codes for 2FA (encrypted)

  @@index([companyId])
  @@index([role])
  @@map("employees")
}

model Document {
  id            String         @id @default(cuid())
  name          String
  path          String
  mimeType      String
  size          Int
  metadata      Json?
  employeeId    String
  companyId     String
  folderId      String?
  expiresAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  uploadedBy    Employee      @relation(fields: [employeeId], references: [id])
  company       Company       @relation(fields: [companyId], references: [id])
  folder        Folder?       @relation(fields: [folderId], references: [id])
  activities    Activity[]
  downloadLinks DownloadLink[]

  @@index([companyId])
  @@index([employeeId])
  @@index([folderId])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("documents")
}

model Folder {
  id            String         @id @default(cuid())
  name          String
  parentId      String?
  companyId     String
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  parent        Folder?       @relation("FolderHierarchy", fields: [parentId], references: [id])
  children      Folder[]      @relation("FolderHierarchy")
  company       Company       @relation(fields: [companyId], references: [id])
  createdBy     Employee      @relation(fields: [createdById], references: [id])
  documents     Document[]
  downloadLinks DownloadLink[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([parentId])
  @@index([createdById])
  @@map("folders")
}

model Activity {
  id          String        @id @default(cuid())
  type        String
  description String
  metadata    Json?
  employeeId  String
  documentId  String?
  companyId   String
  timestamp   DateTime      @default(now())
  ipAddress   String?
  userAgent   String?
  
  employee    Employee      @relation(fields: [employeeId], references: [id])
  document    Document?     @relation(fields: [documentId], references: [id])
  company     Company       @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([documentId])
  @@index([timestamp])
  @@index([type])
  @@map("activities")
}

model DownloadLink {
  id          String        @id @default(cuid())
  token       String        @unique
  folderId    String?
  documentId  String?
  createdById String
  companyId   String
  expiresAt   DateTime
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isActive    Boolean       @default(true)
  downloads   Int           @default(0)

  folder      Folder?       @relation(fields: [folderId], references: [id], onDelete: Cascade)
  document    Document?     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdBy   Employee      @relation(fields: [createdById], references: [id])
  company     Company       @relation(fields: [companyId], references: [id])

  @@index([token])
  @@index([folderId])
  @@index([documentId])
  @@index([companyId])
  @@map("download_links")
}

model UploadLink {
  id          String        @id @default(cuid())
  name        String?
  token       String        @unique
  maxUses     Int
  useCount    Int           @default(0)
  used        Boolean       @default(false)
  expiresAt   DateTime
  metadata    Json?
  employeeId  String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  employee    Employee      @relation(fields: [employeeId], references: [id])

  @@index([token])
  @@index([employeeId])
  @@index([expiresAt])
  @@index([used])
  @@map("upload_links")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  category    String   // "smtp", "upload", "security", "general"
  description String?
  isEncrypted Boolean  @default(false)
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([category])
  @@map("system_settings")
}

model Passkey {
  id              String   @id @default(cuid())
  credentialId    String   @unique
  publicKey       String   // Base64 encoded public key
  counter         Int      @default(0)
  deviceName      String?  // User-friendly name for the device
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime @default(now())

  @@index([employeeId])
  @@index([credentialId])
  @@map("passkeys")
} 